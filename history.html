<!doctype html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">

  <title>Query Search History</title>
  <style>
    * {
      margin: 10px;
    }
  </style>
</head>

<body>
  <div>
    <h2 class="mb-4">History</h2>
    <button id='back' class="btn btn-primary">Back</button>
    <button id='all' class="btn btn-primary">Show All</button>
  </div>

  <div>
    <div class="form-group">
      <h4 class="text-primary">Search by Date Range</h4>
      <h5>Start Date</h5>
      <div class="form-row">

        <div class="form-group col-md-4">
          <label for="inputState">Year</label>
          <select id="startyear" class="form-control">
            <option selected>Choose...</option>
            <option>2020</option>
            <option>2019</option>
            <option>2018</option>
            <option>2017</option>
            <option>2016</option>
          </select>
        </div>
        <div class="form-group col-md-4">
          <label for="inputState">Month</label>
          <select id="startmonth" class="form-control">
            <option selected>Choose...</option>
            <option>January</option>
            <option>Febaury</option>
            <option>March</option>
            <option>April</option>
            <option>May</option>
            <option>June</option>
            <option>July</option>
            <option>August</option>
            <option>September</option>
            <option>October/option>
            <option>November</option>
            <option>December</option>
          </select>
        </div>
        <div class="form-group col-md-4">
          <label for="inputState">Day</label>
          <select id="startday" class="form-control">
            <option selected>Choose...</option>
            <option>1</option>
            <option>2</option>
            <option>3</option>
            <option>4</option>
            <option>5</option>
            <option>6</option>
            <option>7</option>
            <option>8</option>
            <option>9</option>
            <option>10</option>
            <option>11</option>
            <option>12</option>
            <option>13</option>
            <option>14</option>
            <option>15</option>
            <option>16</option>
            <option>17</option>
            <option>18</option>
            <option>19</option>
            <option>20</option>
            <option>21</option>
            <option>22</option>
            <option>23</option>
            <option>24</option>
            <option>25</option>
            <option>26</option>
            <option>27</option>
            <option>28</option>
            <option>29</option>
            <option>30</option>
            <option>31</option>
          </select>
        </div>

      </div>

      <h5>End Date</h5>
      <div class="form-row">

        <div class="form-group col-md-4">
          <label for="inputState">Year</label>
          <select id="endyear" class="form-control">
            <option selected>Choose...</option>
            <option>2020</option>
            <option>2019</option>
            <option>2018</option>
            <option>2017</option>
            <option>2016</option>
          </select>
        </div>
        <div class="form-group col-md-4">
          <label for="inputState">Month</label>
          <select id="endmonth" class="form-control">
            <option selected>Choose...</option>
            <option>January</option>
            <option>Febaury</option>
            <option>March</option>
            <option>April</option>
            <option>May</option>
            <option>June</option>
            <option>July</option>
            <option>August</option>
            <option>September</option>
            <option>October/option>
            <option>November</option>
            <option>December</option>
          </select>
        </div>
        <div class="form-group col-md-4">
          <label for="inputState">Day</label>
          <select id="endday" class="form-control">
            <option selected>Choose...</option>
            <option>1</option>
            <option>2</option>
            <option>3</option>
            <option>4</option>
            <option>5</option>
            <option>6</option>
            <option>7</option>
            <option>8</option>
            <option>9</option>
            <option>10</option>
            <option>11</option>
            <option>12</option>
            <option>13</option>
            <option>14</option>
            <option>15</option>
            <option>16</option>
            <option>17</option>
            <option>18</option>
            <option>19</option>
            <option>20</option>
            <option>21</option>
            <option>22</option>
            <option>23</option>
            <option>24</option>
            <option>25</option>
            <option>26</option>
            <option>27</option>
            <option>28</option>
            <option>29</option>
            <option>30</option>
            <option>31</option>
          </select>
        </div>

      </div>

      <button class="btn btn-primary" id='dateSearch'>Search</button>
    </div>


    <hr>

    <div class="form-group">
      <h4 class="text-primary">Search Last N Records</h4>
      <h5>Choose the number of records</h5>
      <div class="form-row">

        <div class="form-group col-md-4">
          <label for="inputState">Number</label>
          <select id="selectednum" class="form-control">
            <option selected>Choose...</option>
            <option>10</option>
            <option>9</option>
            <option>8</option>
            <option>7</option>
            <option>6</option>
            <option>5</option>
            <option>4</option>
            <option>3</option>
            <option>2</option>
            <option>1</option>
          </select>
        </div>

      </div>

      <button class="btn btn-primary" id='lastNsearch'>Search</button>
    </div>
  </div>
  <hr>
  <h4 class="text-primary">Query Result</h4>
  <div id="output">
  </div>
  <br>

  <script>
    document.getElementById('back').addEventListener('click', goback);
    document.getElementById('all').addEventListener('click', showAll);
    document.getElementById('dateSearch').addEventListener('click', dateSearch);
    document.getElementById('lastNsearch').addEventListener('click', lastNsearch);

    //fetch json from backend and show all records
    function showAll() {
      var url = "/all";
      fetchRecords(url);
    }

    //fetch json from backend and display records that created within a time range
    function dateSearch() {
      var startYear = document.getElementById('startyear').value;
      var startMonth = document.getElementById('startmonth').value;
      var startDay = document.getElementById('startday').value;
      var endYear = document.getElementById('endyear').value;
      var endMonth = document.getElementById('endmonth').value;
      var endDay = document.getElementById('endday').value;
      let startTime = Date.parse(startMonth + " " + startDay + " " + startYear);
      let endTime = Date.parse(endMonth + " " + endDay + " " + endYear);
      var url = "/dateRangeWithin?start=" + startTime + "&" + "end=" + endTime;
      fetchRecords(url);
    }



    //fetch json from backend and display last N records
    function lastNsearch() {
      var n = document.getElementById('selectednum').value;
      var url = "/lastNlocations/" + n;
      fetchRecords(url);
    }

    //helper function which implements the Fetch API
    function fetchRecords(url) {
      fetch(url, {
          'Content-type': 'application/json'
        })
        .then((res) => res.json())
        .then((data) => {
          console.log(data);
          let output = '';
          data.forEach(function(record) {
            var time = new Date(record.createdDate);
            var year = time.getFullYear();
            var month = time.getMonth() + 1;
            var day = time.getDate();
            var h = time.getHours();
            var m = time.getMinutes();
            var s = time.getSeconds();
            output += `<div class="card card-body mb-3">
              <h3>${record.ip}</h3>
              <p>${record.city}</p>
              <p>Added at ${year}-${month}-${day} ${h}:${m}:${s}</p>
            </div>`;
          });
          document.getElementById('output').innerHTML = output;

        }).catch((err) => {
          if (err) {
            throw err;
          }
        })
    }

    //go back to main search screen
    function goback() {
      window.location = '/'
    }
  </script>

</body>

</html>
